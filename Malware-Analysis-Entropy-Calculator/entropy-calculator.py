import math
import sys
from collections import Counter

def calculate_entropy(data):
    """Calculate the Shannon entropy of a byte array and return detailed information."""
    if not data:
        return 0, {}
    
    total_bytes = len(data)
    byte_counts = Counter(data)
    entropy = 0
    byte_details = {}
    
    for byte in range(256):
        count = byte_counts.get(byte, 0)
        p_x = count / total_bytes
        
        byte_info = {
            'count': count,
            'probability': p_x,
            'entropy_contribution': 0
        }
        
        if p_x > 0:
            entropy_contribution = -p_x * math.log2(p_x)
            entropy += entropy_contribution
            byte_info['entropy_contribution'] = entropy_contribution
        
        byte_details[byte] = byte_info
    
    return entropy, byte_details

def main():
    if len(sys.argv) != 2:
        print("Usage: python entropy_calculator.py <filename>")
        sys.exit(1)
    
    filename = sys.argv[1]
    
    try:
        with open(filename, 'rb') as f:
            data = f.read()
    except FileNotFoundError:
        print(f"Error: File '{filename}' not found.")
        sys.exit(1)
    except Exception as e:
        print(f"Error reading file: {e}")
        sys.exit(1)
    
    total_bytes = len(data)
    entropy, byte_details = calculate_entropy(bytearray(data))
    
    # Print overall entropy
    print(f"Entropy of {filename}: {entropy:.6f} bits per byte")
    print(f"Total bytes: {total_bytes}")
    print("-" * 80)
    
    # Print detailed byte information
    print("Byte\tCount\t\tProbability\t\tEntropy Contribution")
    print("-" * 80)
    
    for byte in range(256):
        details = byte_details[byte]
        if details['count'] > 0:
            print(f"0x{byte:02X}\t{details['count']:6d}\t\t{details['probability']:.8f}\t\t{details['entropy_contribution']:.8f}")
    
    # Print summary
    print("-" * 80)
    print(f"Sum of all probabilities: {sum(details['probability'] for details in byte_details.values()):.6f}")
    print(f"Sum of entropy contributions: {entropy:.6f}")

if __name__ == '__main__':
    main()
